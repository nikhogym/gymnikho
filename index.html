<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nikho Gym RPG</title>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/nolan/512/N.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/nolan/512/N.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- ARQUITETURA DE TEMAS (MANTIDA ID√äNTICA) --- */
        :root {
            /* Padr√£o: Apple Neon */
            --bg: #000000; --card: #1C1C1E; --input-bg: #2C2C2E; --text: #FFFFFF;
            --muted: #8E8E93; --border: #3A3A3C; --primary: #0A84FF; --cardio: #FC4C02;
            --outras: #30D158; --xp: #BF5AF2; --gold: #FFD700;
            --radius-card: 20px; --radius-btn: 16px;
        }

        /* Varia√ß√µes de Tema */
        [data-theme="performance"] { --bg: #0D1117; --card: #161B22; --input-bg: #21262d; --text: #c9d1d9; --muted: #8b949e; --border: #30363d; --primary: #2ea043; --cardio: #da3633; --outras: #2ea043; --xp: #1f6feb; --gold: #e3b341; }
        [data-theme="ecosystem"] { --bg: #000000; --card: #111111; --input-bg: #222; --text: #eee; --muted: #666; --border: #333; --primary: #00FF94; --cardio: #FF005C; --outras: #00FF94; --xp: #9D00FF; --gold: #FFD600; }
        [data-theme="nebula"] { --bg: #1a0b2e; --card: rgba(67, 26, 131, 0.3); --input-bg: rgba(0,0,0,0.4); --text: #e0d4fc; --muted: #76659c; --border: rgba(112, 82, 255, 0.3); --primary: #7052ff; --cardio: #ff2a6d; --outras: #05d9e8; --xp: #d23eff; --gold: #f9d71c; }
        [data-theme="titanium"] { --bg: #18181b; --card: #27272a; --input-bg: #3f3f46; --text: #f4f4f5; --muted: #a1a1aa; --border: #52525b; --primary: #f59e0b; --cardio: #ef4444; --outras: #10b981; --xp: #3b82f6; --gold: #fcd34d; }
        [data-theme="vitality"] { --bg: #1c1917; --card: #292524; --input-bg: #44403c; --text: #e7e5e4; --muted: #a8a29e; --border: #57534e; --primary: #84cc16; --cardio: #f97316; --outras: #22c55e; --xp: #a855f7; --gold: #facc15; }
        [data-theme="aurora"] { --bg: #0f172a; --card: rgba(30, 41, 59, 0.7); --input-bg: rgba(51, 65, 85, 0.5); --text: #f1f5f9; --muted: #94a3b8; --border: #334155; --primary: #38bdf8; --cardio: #f472b6; --outras: #2dd4bf; --xp: #818cf8; --gold: #fde047; }
        [data-theme="volt"] { --bg: #050505; --card: #0a0a0a; --input-bg: #1a1a1a; --text: #ffffff; --muted: #555; --border: #333; --primary: #ccff00; --cardio: #ff003c; --outras: #00f0ff; --xp: #b900ff; --gold: #ffff00; --radius-card: 4px; --radius-btn: 2px; }
        [data-theme="apex"] { --bg: #1a0505; --card: #2d0a0a; --input-bg: #450a0a; --text: #ffe4e4; --muted: #b98585; --border: #7f1d1d; --primary: #ff0000; --cardio: #ff6b6b; --outras: #ff0000; --xp: #ff8c00; --gold: #ffcc00; }
        [data-theme="liquid"] { --bg: #001219; --card: rgba(0, 95, 115, 0.2); --input-bg: rgba(10, 147, 150, 0.2); --text: #e0fbfc; --muted: #94d2bd; --border: rgba(10, 147, 150, 0.4); --primary: #00e0ff; --cardio: #ee9b00; --outras: #94d2bd; --xp: #0a9396; --gold: #e9d8a6; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 10px; padding-top: 50px; padding-bottom: 90px;
            transition: all 0.5s ease;
        }

        [data-theme="liquid"] body { background: radial-gradient(circle at bottom, #003049, #000000); background-attachment: fixed; }
        [data-theme="nebula"] body { background: radial-gradient(circle at top right, #3c1361, #000000); background-attachment: fixed; }

        /* --- GAMIFICATION HEADER --- */
        .gamification-bar {
            background: var(--card);
            padding: 12px;
            border-radius: var(--radius-card);
            margin-bottom: 10px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .avatar-container {
            width: 55px; height: 55px;
            background: var(--input-bg);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px;
            border: 2px solid var(--primary);
            box-shadow: 0 0 10px var(--primary);
            animation: pulseAvatar 3s infinite;
        }

        .user-stats { flex: 1; }
        .xp-bar-bg { width: 100%; height: 8px; background: var(--input-bg); border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--xp), var(--primary)); width: 0%; transition: width 1s ease; }

        /* --- DASHBOARD COMPACTO --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-card { background: var(--card); padding: 10px; border-radius: var(--radius-card); text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 16px; font-weight: 900; color: var(--text); }
        .stat-lbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- BOT√ÉO DESTAQUE --- */
        .big-start-btn {
            width: 100%; padding: 25px; 
            background: var(--primary); 
            color: var(--bg);
            border: none; border-radius: var(--radius-card); 
            font-size: 22px; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4); 
            cursor: pointer; margin: 10px 0; 
            position: relative; overflow: hidden; 
            transition: transform 0.2s;
            animation: breathe 2.5s infinite ease-in-out;
            z-index: 10;
            filter: brightness(0.9);
        }
        .big-start-btn:active { transform: scale(0.96); }
        .big-start-btn small { display: block; font-size: 10px; opacity: 0.8; font-weight: normal; margin-top: 4px; }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card); padding: 15px; border-radius: var(--radius-card); margin-bottom: 10px; border: 1px solid var(--border); }
        input, select, textarea { background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text); padding: 12px; width: 100%; margin-bottom: 8px; font-size: 14px; outline: none; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: var(--radius-btn); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .btn-finish { background: var(--outras); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 8px; border-radius: 8px; }

        .quest-item { background: var(--input-bg); padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; font-size: 12px; border-left: 3px solid var(--muted); transition: 0.3s; }
        .quest-item.completed { opacity: 0.5; border-color: var(--outras); text-decoration: line-through; }

        /* --- COLE√á√ÉO --- */
        .collection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .avatar-card { 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            position: relative;
            transition: 0.3s;
            cursor: pointer;
        }
        .avatar-card.locked { opacity: 0.5; filter: grayscale(1); border-style: dashed; }
        .avatar-card.locked::after { content: 'üîí'; position: absolute; top:5px; right: 5px; font-size: 10px; }
        .avatar-card.active { border: 2px solid var(--primary); box-shadow: 0 0 10px var(--primary); background: rgba(255,255,255,0.05); }
        
        .avatar-icon { font-size: 30px; margin-bottom: 5px; display: block; }
        .avatar-name { font-size: 10px; font-weight: bold; color: var(--text); display: block; }
        .avatar-lvl { font-size: 8px; color: var(--muted); text-transform: uppercase; }

        /* --- BADGES --- */
        .badges-section { margin-top: 25px; }
        .badge-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
        .badge-card {
            aspect-ratio: 1;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            position: relative;
            cursor: pointer;
        }
        .badge-card.locked { opacity: 0.2; filter: grayscale(1); }
        .badge-card.unlocked { border-color: var(--gold); box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 300px; text-align: center; border: 1px solid var(--primary); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-avatar { font-size: 60px; margin-bottom: 10px; animation: pulseAvatar 2s infinite; display: inline-block; }

        /* --- ANIMATIONS --- */
        @keyframes breathe { 
            0% { box-shadow: 0 0 5px rgba(0,0,0,0.4); } 
            50% { box-shadow: 0 0 15px var(--primary); } 
            100% { box-shadow: 0 0 5px rgba(0,0,0,0.4); } 
        }
        @keyframes pulseAvatar { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .content { display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .content.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* --- TABS --- */
        #workout-area { display: none; }
        #workout-area.visible { display: block; }
        .tabs { display: flex; gap: 10px; position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 400px; background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); padding: 8px; z-index: 2000; border-radius: 25px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
        .tab-btn { flex: 1; padding: 8px; border: none; background: transparent; color: var(--muted); font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.2s; }
        .tab-btn.active { color: var(--primary); background: var(--input-bg); border-radius: 15px; }
        .tab-btn span { font-size: 16px; }

        .theme-switcher { position: fixed; top: 10px; right: 10px; z-index: 3000; background: var(--input-bg); color: var(--primary); border: 1px solid var(--border); padding: 5px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<button class="theme-switcher" onclick="toggleTheme()">üé® MUDAR TEMA</button>

<div class="container" style="max-width: 450px; margin: auto;">
    
    <div id="treinar" class="content active">
        <div id="dashboard-header">
            
            <div class="gamification-bar" onclick="switchTab('colecao')">
                <div class="avatar-container" id="userAvatar">ü•ö</div>
                <div class="user-stats">
                    <div style="display:flex; justify-content:space-between; font-size: 13px; font-weight: bold;">
                        <span id="userLevelDisplay">N√≠vel 1</span>
                        <span style="color:var(--xp); font-size:10px;">XP</span>
                    </div>
                    <div class="xp-bar-bg">
                        <div class="xp-bar-fill" id="xpBar"></div>
                    </div>
                    <div style="font-size: 10px; color: var(--muted); margin-top: 3px; text-align: right;" id="xpText">0 / 1000</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-val" id="streakDisplay">0</div>
                    <div class="stat-lbl">Dias Seguidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" style="color:var(--gold)" id="pointsDisplay">0</div>
                    <div class="stat-lbl">Pontos</div>
                </div>
            </div>

            <button id="btnStart" class="big-start-btn" onclick="iniciarTreinoUI()">
                ‚ö° INICIAR TREINO
                <small>Toque para come√ßar</small>
            </button>

            <div class="card" style="margin-top: 15px; margin-bottom: 10px;">
                <div style="font-size: 11px; color:var(--muted); font-weight:bold; margin-bottom:8px; text-transform:uppercase;">Miss√µes do Dia</div>
                <div id="dailyQuestsList"></div>
            </div>

            <div style="margin: 0 0 20px 0; text-align: center;">
                <div style="height: 40px; width: 100%; position: relative;">
                    <canvas id="miniSparkline"></canvas>
                </div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 5px;">Atividade Recente</div>
            </div>
        </div>

        <div id="workout-area">
            <button class="btn-outline" style="width:100%; margin-bottom:10px; color:var(--text);" onclick="voltarParaDashboard()">‚¨Ö Cancelar / Voltar</button>

            <div class="card">
                <div style="color: var(--cardio); font-weight:bold; margin-bottom:8px;">üèÉ Cardio</div>
                <select id="storyMode" style="margin-bottom:5px;">
                    <option value="none">Modo Normal</option>
                    <option value="story">Modo Hist√≥ria (Ganho de XP extra)</option>
                </select>
                <input type="number" id="cC" placeholder="Calorias Cardio">
            </div>

            <div class="card">
                <div style="font-weight:bold; margin-bottom:8px;">üèãÔ∏è Muscula√ß√£o</div>
                
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border);">
                    <select id="selectFichaTreino" onchange="carregarFichaNoTreino(this.value)" style="margin-bottom:0;">
                        <option value="">üìÇ Carregar Ficha Salva...</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px;">
                    <input type="text" id="exNome" placeholder="Ex: Supino" oninput="buscarReferencia(this.value)">
                    <button class="btn" style="width: 50px; background: var(--primary); color: var(--bg); margin:0;" onclick="addEx()">+</button>
                </div>
                <div id="referenciaPeso" style="font-size: 11px; color: var(--primary); margin: 5px 0;"></div>
                <div id="listaTreinoAtivo"></div>
            </div>

            <div class="card">
                <div style="color: var(--outras); font-weight:bold; margin-bottom:8px;">‚úÖ Finalizar</div>
                <input type="number" id="cM" placeholder="Calorias Muscula√ß√£o (Estimada)">
                <button class="btn btn-finish" onclick="enviarParaPlanilha()">CONCLUIR TREINO</button>
            </div>
        </div>
    </div>

    <div id="colecao" class="content">
        <div class="card" style="text-align: center;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">TEMA ATUAL</div>
            <h2 id="collectionThemeTitle" style="margin: 0; color: var(--primary);">Apple Neon</h2>
            <p style="font-size: 11px; color: var(--muted);">Suba de n√≠vel para desbloquear novas formas!</p>
            <div class="xp-bar-bg" style="margin: 10px 0;">
                <div class="xp-bar-fill" id="collectionXpBar"></div>
            </div>
        </div>
        <div class="collection-grid" id="avatarGrid"></div>
        
        <div class="badges-section">
            <div style="font-size: 12px; color: var(--muted); font-weight:bold; margin-bottom: 5px; text-transform:uppercase;">Conquistas & Badges (100)</div>
            <div class="card">
                <div id="badgeGrid" class="badge-grid"></div>
            </div>
        </div>
        <div style="height: 60px;"></div>
    </div>

    <div id="fichas" class="content">
        <div class="card">
            <div style="font-weight:bold; margin-bottom:10px;">Criar Ficha</div>
            <input type="text" id="titFicha" placeholder="T√≠tulo">
            <textarea id="txtFicha" rows="4" placeholder="Exerc√≠cios..."></textarea>
            <button class="btn btn-finish" onclick="salvarFicha()">Salvar</button>
        </div>
        <div id="listaFichas"></div>
    </div>

    <div id="calendario" class="content">
        <div class="card">
            <div id="mesAnoAtual" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center;" id="calBody"></div>
        </div>

        <div class="card">
            <div style="font-weight:bold; margin-bottom:10px;">üìà Evolu√ß√£o de Carga</div>
            <select id="selectExGrafico" onchange="renderizarGraficoEvolucao()"></select>
            <div style="height: 180px;"><canvas id="chartCarga"></canvas></div>
        </div>
        
        <div class="card" style="border-color: var(--gold);">
            <div style="font-weight:bold; margin-bottom:10px; color: var(--gold);">üíæ Seguran√ßa de Dados</div>
            <p style="font-size: 11px; color: var(--muted);">Salve seu progresso ou restaure um arquivo anterior.</p>
            <button class="btn-outline" style="width:100%; margin-bottom: 10px;" onclick="exportarDados()">üíæ Salvar Backup (Download)</button>
            
            <input type="file" id="restoreInput" style="display:none" accept=".json" onchange="restaurarBackup(this)">
            <button class="btn" style="width:100%; background: var(--input-bg); border: 1px dashed var(--muted);" onclick="document.getElementById('restoreInput').click()">üìÇ Restaurar Backup</button>
        </div>
        <div style="height: 60px;"></div>
    </div>
</div>

<div class="modal-overlay" id="avatarModal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="modalIconContainer"><div class="modal-avatar" id="modalIcon">ü•ö</div></div>
        <h2 id="modalName" style="margin:0; color:var(--primary)">Nome</h2>
        <div id="modalLvl" style="font-size:10px; color:var(--gold); font-weight:bold; margin:5px 0;">DESBLOQUEIA NO N√çVEL X</div>
        <p id="modalDesc" style="font-size:13px; color:var(--muted); line-height:1.4;">Descri√ß√£o</p>
        
        <div id="modalContentBody" style="text-align: left; margin-top:10px; font-size:12px; color:var(--text);"></div>
        
        <button class="btn" style="margin-top:15px; background: var(--input-bg);" onclick="closeModal()">Fechar</button>
    </div>
</div>

<div class="tabs">
    <button id="tab-treinar" class="tab-btn active" onclick="switchTab('treinar')"><span>üí™</span>Treino</button>
    <button id="tab-colecao" class="tab-btn" onclick="switchTab('colecao')"><span>üß©</span>Cole√ß√£o</button>
    <button id="tab-fichas" class="tab-btn" onclick="switchTab('fichas')"><span>üìã</span>Fichas</button>
    <button id="tab-calendario" class="tab-btn" onclick="switchTab('calendario')"><span>üìÖ</span>Hist.</button>
</div>

<script>
    const MISSIONS_POOL = [
        "Beber 3L de √°gua", "Beber 1 copo d'√°gua ao acordar", "Trocar refri por √°gua", "Beber 500ml antes do almo√ßo", "Garrafa de √°gua sempre cheia",
        "Comer 2 frutas", "Comer salada no almo√ßo", "Sem a√ß√∫car adicionado hoje", "Bater a meta de prote√≠na", "Jantar leve antes das 20h",
        "Evitar frituras hoje", "Comer 1 por√ß√£o de castanhas", "Sem fast-food hoje", "Cozinhar sua pr√≥pria refei√ß√£o", "Comer devagar e sem telas",
        "Treinar 30 min", "Fazer 20 flex√µes", "Fazer 1 min de prancha", "Alongar por 5 min", "Caminhar 10 min p√≥s-almo√ßo",
        "Subir escadas em vez de elevador", "Fazer 50 polichinelos", "Treinar perna pesado", "Fazer 15 min de cardio", "Bater 8.000 passos",
        "Tentar um exerc√≠cio novo", "Melhorar a carga em 1 exerc√≠cio", "Fazer mobilidade de quadril", "Pular corda por 2 min", "Treinar at√© a falha em 1 s√©rie",
        "Dormir 7h+", "Acordar sem soneca", "Arrumar a cama ao levantar", "Ler 5 p√°ginas de um livro", "Tomar 10 min de sol",
        "Banho gelado (opcional)", "Desconectar 30 min antes de dormir", "Organizar a mochila do treino", "Lavar a lou√ßa logo ap√≥s comer", "Zero √°lcool hoje",
        "Agradecer por 3 coisas", "Visualizar o shape meta", "N√£o reclamar por 24h", "Ouvir um podcast motivacional", "Meditar por 5 min",
        "Escrever as metas de amanh√£", "Elogiar algu√©m", "Sorrir no espelho", "Respirar fundo 10 vezes", "Focar no processo, n√£o no resultado",
        "Dobrar a meta de cardio", "Treino em jejum", "Super-s√©rie no treino", "Correr 1km extra", "Ficar 24h sem doces"
    ];

    const THEME_DATA = {
        'apple': { name: 'Neon Tech', avatars: [ { l:1, i:'üíæ', n:'Disquete', d:'Mem√≥ria curta, mas o come√ßo de tudo.' }, { l:3, i:'üîã', n:'Bateria', d:'Acumulando energia para o que vem por a√≠.' }, { l:5, i:'üìü', n:'Pager', d:'Comunica√ß√£o b√°sica estabelecida.' }, { l:8, i:'üì±', n:'Smartphone', d:'Conectado e vers√°til.' }, { l:12, i:'üíª', n:'Laptop', d:'Processamento m√≥vel de alta performance.' }, { l:16, i:'üñ•Ô∏è', n:'Workstation', d:'Poder bruto estacion√°rio.' }, { l:20, i:'üì°', n:'Sat√©lite', d:'Vis√£o global e alcance ilimitado.' }, { l:25, i:'‚òÅÔ∏è', n:'Cloud', d:'Onipresente e intoc√°vel.' }, { l:30, i:'ü§ñ', n:'AI Alpha', d:'Atingiu a senci√™ncia digital.' }, { l:40, i:'ü¶æ', n:'Singularidade', d:'A fus√£o perfeita entre homem e m√°quina.' } ] },
        'performance': { name: 'Atleta Pro', avatars: [ { l:1, i:'üëü', n:'Iniciante', d:'Amarrou o t√™nis e saiu do sof√°.' }, { l:3, i:'üíß', n:'Suor', d:'Come√ßando a entender o esfor√ßo.' }, { l:5, i:'üß¥', n:'Hidratado', d:'A const√¢ncia exige cuidado.' }, { l:8, i:'üßò', n:'Focado', d:'Mente e corpo em sintonia.' }, { l:12, i:'üèãÔ∏è', n:'Levantador', d:'As cargas come√ßam a subir.' }, { l:16, i:'üèÉ', n:'Velocista', d:'Explos√£o e agilidade dominadas.' }, { l:20, i:'ü•á', n:'Medalhista', d:'Reconhecimento pelo esfor√ßo.' }, { l:25, i:'üèÜ', n:'Campe√£o', d:'O topo do p√≥dio √© sua casa.' }, { l:30, i:'üèüÔ∏è', n:'Lenda', d:'Seu nome lota est√°dios.' }, { l:40, i:'üëë', n:'GOAT', d:'O Maior de Todos os Tempos.' } ] },
        'liquid': { name: 'Ocean Deep', avatars: [ { l:1, i:'üíß', n:'Gota', d:'Uma pequena parte de algo maior.' }, { l:3, i:'ü´ß', n:'Bolha', d:'Subindo em dire√ß√£o √† superf√≠cie.' }, { l:5, i:'ü¶ê', n:'Pl√¢ncton', d:'A base da cadeia alimentar.' }, { l:8, i:'ü¶Ä', n:'Caranguejo', d:'Casca dura, dif√≠cil de quebrar.' }, { l:12, i:'üê†', n:'Peixe Tropical', d:'√Ågil e cheio de cor.' }, { l:16, i:'üê¢', n:'Tartaruga', d:'Resist√™ncia e longevidade.' }, { l:20, i:'üê¨', n:'Golfinho', d:'Intelig√™ncia e velocidade.' }, { l:25, i:'ü¶à', n:'Tubar√£o', d:'O predador dos mares.' }, { l:30, i:'üêã', n:'Baleia Azul', d:'Majestade inabal√°vel.' }, { l:40, i:'üî±', n:'Poseidon', d:'O regente dos sete mares.' } ] },
        'apex': { name: 'Predador', avatars: [ { l:1, i:'ü•ö', n:'Ovo', d:'Potencial latente esperando eclodir.' }, { l:3, i:'ü¶é', n:'Lagarto', d:'R√°pido e adapt√°vel.' }, { l:5, i:'üêç', n:'Serpente', d:'Silencioso e letal.' }, { l:8, i:'ü¶Ö', n:'Falc√£o', d:'Vis√£o agu√ßada, ataque preciso.' }, { l:12, i:'üê∫', n:'Lobo', d:'Forte sozinho, invenc√≠vel em bando.' }, { l:16, i:'üêÜ', n:'Leopardo', d:'Velocidade pura.' }, { l:20, i:'ü¶ç', n:'Gorila', d:'For√ßa bruta incontrol√°vel.' }, { l:25, i:'ü¶Å', n:'Rei Le√£o', d:'Domin√¢ncia territorial absoluta.' }, { l:30, i:'ü¶ñ', n:'T-Rex', d:'O terror da pr√©-hist√≥ria.' }, { l:40, i:'üêâ', n:'Drag√£o', d:'Poder m√≠tico lend√°rio.' } ] },
        'nebula': { name: 'Cosmos', avatars: [ { l:1, i:'üåë', n:'Poeira', d:'Mat√©ria dispersa no v√°cuo.' }, { l:3, i:'‚òÑÔ∏è', n:'Meteoro', d:'Ganhando velocidade e impacto.' }, { l:5, i:'üõ∞Ô∏è', n:'Sat√©lite', d:'Em √≥rbita est√°vel.' }, { l:8, i:'üöÄ', n:'Foguete', d:'Rompendo a atmosfera.' }, { l:12, i:'üåï', n:'Lua', d:'Iluminando a escurid√£o.' }, { l:16, i:'ü™ê', n:'Planeta', d:'Um mundo inteiro a descobrir.' }, { l:20, i:'‚òÄÔ∏è', n:'Estrela', d:'Gerando sua pr√≥pria energia.' }, { l:25, i:'üí•', n:'Supernova', d:'Explos√£o de poder c√≥smico.' }, { l:30, i:'üï≥Ô∏è', n:'Buraco Negro', d:'Gravidade infinita.' }, { l:40, i:'üåå', n:'Gal√°xia', d:'Um universo em si mesmo.' } ] },
        'volt': { name: 'Alta Voltagem', avatars: [ { l:1, i:'üïØÔ∏è', n:'Fa√≠sca', d:'Um pequeno brilho na escurid√£o.' }, { l:3, i:'üí°', n:'L√¢mpada', d:'Ideias brilhantes surgindo.' }, { l:5, i:'üîã', n:'Pilha', d:'Energia port√°til.' }, { l:8, i:'üîå', n:'Conectado', d:'Fluxo constante de for√ßa.' }, { l:12, i:'‚ö°', n:'Rel√¢mpago', d:'R√°pido e impactante.' }, { l:16, i:'üîã', n:'Gerador', d:'Sustentando o sistema.' }, { l:20, i:'üè≠', n:'Usina', d:'Produ√ß√£o em escala industrial.' }, { l:25, i:'‚ò¢Ô∏è', n:'Reator', d:'Poder nuclear contido.' }, { l:30, i:'‚òÄÔ∏è', n:'Fus√£o Solar', d:'A fonte de energia suprema.' }, { l:40, i:'üå©Ô∏è', n:'Zeus', d:'O senhor dos raios.' } ] },
        'titanium': { name: 'Mecha', avatars: [ { l:1, i:'üî©', n:'Porca', d:'Uma pe√ßa pequena, mas essencial.' }, { l:3, i:'üîß', n:'Ferramenta', d:'Ajustando as engrenagens.' }, { l:5, i:'‚öôÔ∏è', n:'Engrenagem', d:'Parte do mecanismo.' }, { l:8, i:'‚õìÔ∏è', n:'Corrente', d:'For√ßa de tra√ß√£o.' }, { l:12, i:'üè≠', n:'Motor V8', d:'Combust√£o interna potente.' }, { l:16, i:'üöÅ', n:'Drone', d:'Automa√ß√£o a√©rea.' }, { l:20, i:'ü¶æ', n:'Ciborgue', d:'Melhoria bi√¥nica.' }, { l:25, i:'ü§ñ', n:'Android', d:'Intelig√™ncia artificial humanoide.' }, { l:30, i:'üöÄ', n:'Mecha', d:'Armadura de combate gigante.' }, { l:40, i:'üõ∏', n:'Mave M√£e', d:'Tecnologia alien√≠gena superior.' } ] },
        'vitality': { name: 'Gaia', avatars: [ { l:1, i:'üå∞', n:'Semente', d:'Enterrada, esperando a chuva.' }, { l:3, i:'üå±', n:'Broto', d:'Rompendo a terra.' }, { l:5, i:'üåø', n:'Erva', d:'Crescimento r√°pido.' }, { l:8, i:'üéã', n:'Bambu', d:'Flex√≠vel e resistente.' }, { l:12, i:'üå≥', n:'Carvalho', d:'Ra√≠zes profundas.' }, { l:16, i:'ü¶ç', n:'Guardi√£o', d:'Protetor da floresta.' }, { l:20, i:'üèûÔ∏è', n:'Montanha', d:'Im√≥vel e eterno.' }, { l:25, i:'üåã', n:'Vulc√£o', d:'A f√∫ria da terra.' }, { l:30, i:'üåç', n:'Mundo', d:'Ecossistema completo.' }, { l:40, i:'‚ú®', n:'Esp√≠rito', d:'A alma da natureza.' } ] },
        'aurora': { name: 'Frost', avatars: [ { l:1, i:'‚ùÑÔ∏è', n:'Floco', d:'√önico e fr√°gil.' }, { l:3, i:'üßä', n:'Cubo', d:'S√≥lido e frio.' }, { l:5, i:'‚òÉÔ∏è', n:'Boneco', d:'Forma moldada na neve.' }, { l:8, i:'‚õ∏Ô∏è', n:'Patins', d:'Deslizando sobre problemas.' }, { l:12, i:'üêß', n:'Pinguim', d:'Resiliente ao extremo.' }, { l:16, i:'üê∫', n:'Lobo Branco', d:'Ca√ßador da tundra.' }, { l:20, i:'üêª‚Äç‚ùÑÔ∏è', n:'Urso Polar', d:'O rei do gelo.' }, { l:25, i:'üèîÔ∏è', n:'Glaciar', d:'Uma for√ßa da natureza impar√°vel.' }, { l:30, i:'üå¨Ô∏è', n:'Nevasca', d:'O poder da tempestade.' }, { l:40, i:'üíé', n:'Zero Absoluto', d:'A perfei√ß√£o cristalina.' } ] },
        'ecosystem': { name: 'Digital', avatars: [ { l:1, i:'‚ö´', n:'Pixel', d:'Um ponto na tela.' }, { l:3, i:'üëæ', n:'Glitch', d:'Erro no sistema.' }, { l:5, i:'üíæ', n:'8-Bit', d:'A era de ouro.' }, { l:8, i:'üïπÔ∏è', n:'Joystick', d:'Controle total.' }, { l:12, i:'üåê', n:'Web', d:'Conectado a tudo.' }, { l:16, i:'üõ°Ô∏è', n:'Firewall', d:'Defesa impenetr√°vel.' }, { l:20, i:'üíª', n:'Hacker', d:'Quebrando c√≥digos.' }, { l:25, i:'üï∂Ô∏è', n:'VR', d:'Realidade simulada.' }, { l:30, i:'üß†', n:'Rede Neural', d:'Aprendizado profundo.' }, { l:40, i:'üåå', n:'Metaverso', d:'Realidade infinita.' } ] }
    };

    let user = JSON.parse(localStorage.getItem('user_nikho')) || { level: 1, xp: 0, nextXp: 500, points: 0, streak: 0, badges: [] };
    if(!user.badges) user.badges = [];

    let hist = JSON.parse(localStorage.getItem('hist_nikho')) || [];
    let sessao = [];
    let currentTheme = localStorage.getItem('theme_nikho') || 'apple';

    function getThemeData() { return THEME_DATA[currentTheme] || THEME_DATA['apple']; }

    function getCurrentAvatarObj() {
        const data = getThemeData();
        let found = data.avatars[0];
        for (let av of data.avatars) {
            if (user.level >= av.l) found = av;
            else break; 
        }
        return found;
    }

    function updateGamificationUI() {
        const currentAv = getCurrentAvatarObj();
        document.getElementById('userAvatar').innerText = currentAv.i;
        const perc = Math.min(100, (user.xp / user.nextXp) * 100);
        document.getElementById('xpBar').style.width = perc + '%';
        document.getElementById('collectionXpBar').style.width = perc + '%';
        document.getElementById('xpText').innerText = `${Math.floor(user.xp)} / ${user.nextXp}`;
        document.getElementById('userLevelDisplay').innerText = `N√≠vel ${user.level}`;
        document.getElementById('streakDisplay').innerText = user.streak;
        document.getElementById('pointsDisplay').innerText = user.points;
    }

    function renderCollection() {
        const data = getThemeData();
        const grid = document.getElementById('avatarGrid');
        grid.innerHTML = '';
        document.getElementById('collectionThemeTitle').innerText = data.name;
        data.avatars.forEach(av => {
            const unlocked = user.level >= av.l;
            const isCurrent = getCurrentAvatarObj().n === av.n;
            const el = document.createElement('div');
            el.className = `avatar-card ${unlocked ? (isCurrent ? 'active' : '') : 'locked'}`;
            el.onclick = () => showModal(av, unlocked);
            el.innerHTML = `<span class="avatar-icon">${av.i}</span><span class="avatar-name">${unlocked ? av.n : '???'}</span><span class="avatar-lvl">LVL ${av.l}</span>`;
            grid.appendChild(el);
        });
        renderBadges();
    }

    function renderBadges() {
        const badgeGrid = document.getElementById('badgeGrid');
        badgeGrid.innerHTML = '';
        const badgesList = BADGE_DATABASE[currentTheme] || BADGE_DATABASE['apple'];
        badgesList.forEach(b => {
            const hasBadge = user.badges.includes(b.n);
            const el = document.createElement('div');
            el.className = `badge-card ${hasBadge ? 'unlocked' : 'locked'}`;
            el.innerHTML = b.i;
            el.onclick = () => {
                document.getElementById('avatarModal').style.display = 'flex';
                document.getElementById('modalIconContainer').style.display = 'block';
                document.getElementById('modalContentBody').innerHTML = ''; 
                document.getElementById('modalIcon').innerText = b.i;
                document.getElementById('modalName').innerText = hasBadge ? b.n : 'Bloqueado';
                document.getElementById('modalLvl').innerText = hasBadge ? 'CONQUISTA DESBLOQUEADA' : 'CONQUISTA BLOQUEADA';
                document.getElementById('modalLvl').style.color = hasBadge ? 'var(--gold)' : 'var(--muted)';
                document.getElementById('modalDesc').innerText = hasBadge ? b.d : "Continue treinando e completando desafios para desbloquear aleatoriamente.";
            };
            badgeGrid.appendChild(el);
        });
    }

    function tentaDesbloquearConquista() {
        if (Math.random() > 0.3) return;
        const themeKeys = Object.keys(BADGE_DATABASE);
        const randomTheme = themeKeys[Math.floor(Math.random() * themeKeys.length)];
        const themeBadges = BADGE_DATABASE[randomTheme];
        const unowned = themeBadges.filter(b => !user.badges.includes(b.n));
        if (unowned.length > 0) {
            const newBadge = unowned[Math.floor(Math.random() * unowned.length)];
            user.badges.push(newBadge.n);
            localStorage.setItem('user_nikho', JSON.stringify(user));
            alert(`üèÜ NOVA CONQUISTA DESBLOQUEADA!\n\n${newBadge.i} ${newBadge.n}\n"${newBadge.d}"`);
            confetti({particleCount: 200, spread: 100, origin: { y: 0.6 }});
        }
    }

    function showModal(av, unlocked) {
        document.getElementById('avatarModal').style.display = 'flex';
        document.getElementById('modalIconContainer').style.display = 'block';
        document.getElementById('modalContentBody').innerHTML = ''; 
        document.getElementById('modalIcon').innerText = av.i;
        document.getElementById('modalName').innerText = unlocked ? av.n : 'Bloqueado';
        document.getElementById('modalLvl').innerText = unlocked ? `DESBLOQUEADO` : `DESBLOQUEIA NO N√çVEL ${av.l}`;
        document.getElementById('modalLvl').style.color = unlocked ? 'var(--outras)' : 'var(--gold)';
        document.getElementById('modalDesc').innerText = unlocked ? av.d : "Continue treinando para descobrir o que √©.";
    }

    function closeModal() { document.getElementById('avatarModal').style.display = 'none'; }

    // --- ATUALIZADO: DETALHES COMPLETOS NO HIST√ìRICO ---
    function verDetalhesDia(dataStr) {
        const diaTreino = hist.find(h => h.data === dataStr);
        if(!diaTreino) return;

        document.getElementById('avatarModal').style.display = 'flex';
        document.getElementById('modalIconContainer').style.display = 'none';
        
        document.getElementById('modalName').innerText = `Treino de ${dataStr.split('/').slice(0,2).join('/')}`;
        document.getElementById('modalLvl').innerText = `${diaTreino.calTotal} KCAL GASTAS`;
        document.getElementById('modalLvl').style.color = 'var(--cardio)';
        document.getElementById('modalDesc').innerText = "Resumo detalhado:";

        let htmlContent = `<div style="border-top:1px solid var(--border); padding-top:10px; margin-top:10px;">`;
        
        if (diaTreino.exercicios && diaTreino.exercicios.length > 0) {
            diaTreino.exercicios.forEach(ex => {
                // Monta string de todas as s√©ries
                const seriesDet = ex.series.map(s => `${s.r}x${s.p}kg`).join(', ');
                
                htmlContent += `
                    <div style="background:var(--input-bg); padding:8px; border-radius:6px; margin-bottom:5px;">
                        <div style="font-weight:bold; margin-bottom:2px;">${ex.nome}</div>
                        <div style="color:var(--muted); font-size:10px;">${seriesDet}</div>
                    </div>`;
            });
        } else {
            htmlContent += `<div style="color:var(--muted); font-style:italic;">Apenas Cardio registrado.</div>`;
        }
        
        htmlContent += `<div style="margin-top:15px; font-size:10px; color:var(--gold); text-align:center;">üåü Continue consistente!</div>`;
        
        htmlContent += `</div>`;
        document.getElementById('modalContentBody').innerHTML = htmlContent;
    }

    function toggleTheme() {
        const themes = ['apple', 'performance', 'liquid', 'apex', 'nebula', 'volt', 'titanium', 'vitality', 'aurora', 'ecosystem'];
        let idx = (themes.indexOf(currentTheme) + 1) % themes.length;
        currentTheme = themes[idx];
        if (currentTheme === 'apple') document.body.removeAttribute('data-theme');
        else document.body.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme_nikho', currentTheme);
        updateGamificationUI();
        renderCollection();
    }

    function iniciarTreinoUI() {
        document.getElementById('dashboard-header').style.display = 'none';
        document.getElementById('workout-area').classList.add('visible');
        
        // POPULA O DROPDOWN DE FICHAS AO INICIAR
        const fichas = JSON.parse(localStorage.getItem('fichas_nikho')) || [];
        const select = document.getElementById('selectFichaTreino');
        if(fichas.length > 0) {
            select.innerHTML = `<option value="">üìÇ Carregar Ficha Salva...</option>` + 
                fichas.map(f => `<option value="${f.txt.replace(/\n/g, '|')}">${f.t}</option>`).join('');
        } else {
            select.innerHTML = `<option value="">Sem fichas salvas</option>`;
        }
    }
    
    // NOVA FUN√á√ÉO PARA CARREGAR DO DROPDOWN
    function carregarFichaNoTreino(txt) {
        if(!txt) return;
        carregarFicha(txt);
        // Reseta o select para o t√≠tulo
        document.getElementById('selectFichaTreino').value = "";
    }

    function voltarParaDashboard() {
        document.getElementById('workout-area').classList.remove('visible');
        document.getElementById('dashboard-header').style.display = 'block';
    }

    function addEx() {
        const n = document.getElementById('exNome').value;
        if(n) {
            let seriesToUse = [{r:'',p:''},{r:'',p:''},{r:'',p:''}];
            const lastRecord = hist.slice().reverse().find(h => 
                h.exercicios.some(e => e.nome.toLowerCase() === n.toLowerCase().trim())
            );

            if(lastRecord) {
                const lastEx = lastRecord.exercicios.find(e => e.nome.toLowerCase() === n.toLowerCase().trim());
                if(lastEx && lastEx.series) {
                    seriesToUse = JSON.parse(JSON.stringify(lastEx.series));
                }
            }

            sessao.push({ id: Date.now(), nome: n, series: seriesToUse });
            renderSessao();
            document.getElementById('exNome').value = "";
        }
    }

    function renderSessao() {
        document.getElementById('listaTreinoAtivo').innerHTML = sessao.map(ex => `
            <div style="background:var(--input-bg); padding:10px; border-radius:10px; margin-bottom:5px; border-left:3px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong>${ex.nome}</strong> 
                    <span onclick="removerEx(${ex.id})" style="color:var(--cardio); font-weight:bold;">‚úï</span>
                </div>
                ${ex.series.map((s, i) => `
                    <div style="display:grid; grid-template-columns: 15px 1fr 1fr; gap:5px; margin-bottom:5px; align-items:center;">
                        <span style="color:var(--muted); font-size:10px;">${i+1}</span>
                        <input type="number" placeholder="Reps" value="${s.r}" onchange="editSerie(${ex.id}, ${i}, 'r', this.value)" style="padding:8px; margin:0;">
                        <input type="number" placeholder="Kg" value="${s.p}" onchange="editSerie(${ex.id}, ${i}, 'p', this.value)" style="padding:8px; margin:0;">
                    </div>`).join('')}
            </div>`).join('');
    }

    function editSerie(id, i, f, v) { sessao.find(e => e.id === id).series[i][f] = v; }
    function removerEx(id) { sessao = sessao.filter(e => e.id !== id); renderSessao(); }

    // --- ATUALIZADO: DETALHES COMPLETOS NO INPUT ---
    function buscarReferencia(nome) {
        if (!nome || nome.length < 2) return;
        const termo = nome.toLowerCase().trim();
        const ultimo = hist.slice().reverse().find(t => (t.exercicios || []).some(e => e.nome.toLowerCase().includes(termo)));
        if (ultimo) {
            const exData = ultimo.exercicios.find(e => e.nome.toLowerCase().includes(termo));
            // Monta string com todas as s√©ries
            const details = exData.series.map((s, i) => `${i+1}¬™: ${s.r}x${s.p}kg`).join(' | ');
            document.getElementById('referenciaPeso').innerText = `√öltima: ${details}`;
        }
    }

    function enviarParaPlanilha() {
        if(!confirm("Finalizar Treino?")) return;
        const calTotal = Number(document.getElementById('cM').value) + Number(document.getElementById('cC').value);
        hist.push({ id: Date.now(), data: new Date().toLocaleDateString('pt-BR'), hora: new Date().getHours(), calTotal, calC: Number(document.getElementById('cC').value), exercicios: [...sessao] });
        localStorage.setItem('hist_nikho', JSON.stringify(hist));
        const totalXP = 150 + Math.floor(calTotal * 0.2) + (document.getElementById('storyMode').value === 'story' ? 50 : 0);
        user.xp += totalXP;
        user.points += Math.floor(totalXP / 2);
        if(user.xp >= user.nextXp) {
            user.level++;
            user.xp -= user.nextXp;
            user.nextXp = Math.floor(user.nextXp * 1.3);
            alert(`üéâ LEVEL UP! N√≠vel ${user.level}!`);
            confetti({particleCount: 150, spread: 80});
        }
        localStorage.setItem('user_nikho', JSON.stringify(user));
        
        tentaDesbloquearConquista();

        sessao = [];
        voltarParaDashboard();
        updateGamificationUI();
        renderCollection();
    }

    function switchTab(aba) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(aba).classList.add('active');
        document.getElementById('tab-' + aba).classList.add('active');
        if(aba === 'colecao') renderCollection();
        if(aba === 'calendario') {
            renderCalendario();
            renderizarGraficoEvolucao();
        }
        if(aba === 'fichas') renderFichas();
    }
    
    function salvarFicha() {
        let f = JSON.parse(localStorage.getItem('fichas_nikho')) || [];
        f.push({ t: document.getElementById('titFicha').value, txt: document.getElementById('txtFicha').value });
        localStorage.setItem('fichas_nikho', JSON.stringify(f));
        renderFichas();
    }
    
    function renderFichas() {
        let f = JSON.parse(localStorage.getItem('fichas_nikho')) || [];
        document.getElementById('listaFichas').innerHTML = f.map(item => `<div class="card" onclick="carregarFicha('${item.txt.replace(/\n/g, '|')}')"><strong>${item.t}</strong><br><small style="color:var(--muted)">Toque para carregar</small></div>`).join('');
    }
    
    function carregarFicha(txt) {
        txt.split('|').forEach(n => { 
            const cleanName = n.trim();
            if(cleanName) {
                let seriesToUse = [{r:'',p:''},{r:'',p:''},{r:'',p:''}];
                const lastRecord = hist.slice().reverse().find(h => 
                    h.exercicios.some(e => e.nome.toLowerCase() === cleanName.toLowerCase())
                );

                if(lastRecord) {
                    const lastEx = lastRecord.exercicios.find(e => e.nome.toLowerCase() === cleanName.toLowerCase());
                    if(lastEx && lastEx.series) {
                        seriesToUse = JSON.parse(JSON.stringify(lastEx.series));
                    }
                }

                sessao.push({ 
                    id: Date.now() + Math.random(), 
                    nome: cleanName, 
                    series: seriesToUse 
                }); 
            }
        });
        renderSessao(); 
        // Se j√° estiver no treino (chamado pelo select), n√£o precisa mudar tab ou iniciar UI de novo,
        // mas se for chamado da aba Fichas, executa:
        if(!document.getElementById('workout-area').classList.contains('visible')) {
            switchTab('treinar'); 
            iniciarTreinoUI();
        }
    }

    function renderCalendario() {
        const body = document.getElementById('calBody');
        const now = new Date();
        document.getElementById('mesAnoAtual').innerText = now.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        body.innerHTML = '';
        const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
        for(let d=1; d<=days; d++) {
            const ds = `${d.toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
            const trained = hist.find(h => h.data === ds);
            
            const clickEvent = trained ? `onclick="verDetalhesDia('${ds}')"` : '';
            const cursorStyle = trained ? 'cursor:pointer;' : '';
            
            body.innerHTML += `<div ${clickEvent} style="padding:6px; border-radius:6px; font-size:12px; background:${trained?'var(--primary)':'var(--input-bg)'}; color:${trained?'var(--bg)':'var(--muted)'}; ${cursorStyle}">${d}</div>`;
        }
    }
    
    function renderizarGraficoEvolucao() {
        const n = [...new Set(hist.flatMap(t => (t.exercicios || []).map(e => e.nome)))];
        const sel = document.getElementById('selectExGrafico');
        if(sel.options.length === 0) sel.innerHTML = n.map(x => `<option value="${x}">${x}</option>`).join('');
        const ex = sel.value;
        if(!ex) return;
        const d = hist.filter(t => (t.exercicios || []).some(e => e.nome === ex)).map(t => ({ label: t.data.split('/')[0], val: Math.max(...t.exercicios.find(e => e.nome === ex).series.map(s => parseFloat(s.p) || 0)) }));
        if(window.chartInstance) window.chartInstance.destroy();
        window.chartInstance = new Chart(document.getElementById('chartCarga'), { type: 'line', data: { labels: d.map(x=>x.label), datasets: [{ data: d.map(x=>x.val), borderColor: getComputedStyle(document.body).getPropertyValue('--primary'), tension: 0.3 }] }, options: { plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}},y:{grid:{color:'#333'}}} } });
    }

    function exportarDados() {
        const dataStr = JSON.stringify({
            hist: hist, 
            user: user, 
            fichas: JSON.parse(localStorage.getItem('fichas_nikho')),
            theme: localStorage.getItem('theme_nikho')
        });
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `nikho_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function sincronizarProgressoComHistorico() {
        if (hist.length > 0) {
            let totalXPRecalculado = 0;
            hist.forEach(h => {
                totalXPRecalculado += 150 + Math.floor(h.calTotal * 0.2);
            });

            if (totalXPRecalculado > user.xp + (user.level * 500)) { 
                let tempLevel = 1;
                let tempNextXp = 500;
                let tempXp = totalXPRecalculado;
                
                while (tempXp >= tempNextXp) {
                    tempXp -= tempNextXp;
                    tempLevel++;
                    tempNextXp = Math.floor(tempNextXp * 1.3);
                }
                
                user.level = tempLevel;
                user.xp = tempXp;
                user.nextXp = tempNextXp;
                user.points = Math.floor(totalXPRecalculado / 2);
                localStorage.setItem('user_nikho', JSON.stringify(user));
                alert(`üîÑ Sincroniza√ß√£o Conclu√≠da: Hist√≥rico analisado! Voc√™ foi restaurado para o N√≠vel ${user.level}.`);
            }
        }
        updateGamificationUI();
        renderCollection(); 
    }

    function restaurarBackup(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if(data.user) localStorage.setItem('user_nikho', JSON.stringify(data.user));
                if(data.hist) localStorage.setItem('hist_nikho', JSON.stringify(data.hist));
                if(data.fichas) localStorage.setItem('fichas_nikho', JSON.stringify(data.fichas));
                if(data.theme) localStorage.setItem('theme_nikho', data.theme);

                user = data.user || user;
                hist = data.hist || hist;
                currentTheme = data.theme || currentTheme;

                sincronizarProgressoComHistorico(); 

                alert("Backup restaurado com sucesso! Recompensas recalculadas.");
                location.reload();
            } catch (err) {
                alert("Erro ao ler arquivo de backup. Verifique se √© um JSON v√°lido.");
            }
        };
        reader.readAsText(file);
    }

    window.onload = () => {
        if(currentTheme !== 'apple') document.body.setAttribute('data-theme', currentTheme);
        updateGamificationUI();
        generateQuests();
        new Chart(document.getElementById('miniSparkline').getContext('2d'), {
            type: 'bar',
            data: { labels: [1,2,3,4,5,6,7], datasets: [{ data: hist.slice(-7).map(h=>h.calTotal), backgroundColor: getComputedStyle(document.body).getPropertyValue('--primary') }] },
            options: { plugins:{legend:false}, scales:{x:{display:false},y:{display:false}}, responsive:true, maintainAspectRatio:false }
        });
    }

    function generateQuests() {
        const today = new Date().toDateString();
        if(!user.quests || user.quests.length === 0 || user.questsDate !== today) {
            const shuffled = MISSIONS_POOL.sort(() => 0.5 - Math.random());
            user.quests = shuffled.slice(0, 3).map(t => ({txt: t, xp: 50, done: false}));
            user.questsDate = today;
            localStorage.setItem('user_nikho', JSON.stringify(user));
        }
        document.getElementById('dailyQuestsList').innerHTML = user.quests.map((q, i) => `<div class="quest-item ${q.done ? 'completed' : ''}" onclick="completeQuest(${i})"><div style="width:16px; height:16px; border:1px solid var(--muted); border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:10px;">${q.done?'‚úì':''}</div><div style="flex:1;">${q.txt}</div><div style="font-weight:bold; color:var(--xp); font-size:10px;">+50 XP</div></div>`).join('');
    }
    
    function completeQuest(i) {
        if(!user.quests[i].done) {
            user.quests[i].done = true;
            user.xp += 50;
            localStorage.setItem('user_nikho', JSON.stringify(user));
            updateGamificationUI();
            generateQuests();
            tentaDesbloquearConquista();
            confetti({particleCount: 50, spread: 60, origin: { y: 0.7 }});
        }
    }
</script>
</body>
</html>
